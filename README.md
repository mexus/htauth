# htauth

A library and CLI tool for managing htpasswd files with support for bcrypt, SHA-256, SHA-512, and APR1-MD5 password hashing.

**Dual-licensed under MIT or Apache-2.0**

---

## For CLI Users

### Installation

```bash
cargo install htauth-cli
```

### Quick Start

```bash
# Add a user (passwords are prompted securely)
htauth add .htpasswd alice

# Add with specific hash algorithm
htauth add .htpasswd bob --algorithm sha256

# Verify a password
htauth verify .htpasswd alice

# List all users
htauth list .htpasswd

# Update a user's password
htauth update .htpasswd alice

# Delete a user
htauth delete .htpasswd alice
```

### Commands

| Command | Description |
|---------|-------------|
| `add` | Add a new user to the password file |
| `update` | Update an existing user's password |
| `verify` | Verify a user's password |
| `list` | List all users in the password file |
| `delete` | Delete a user from the password file |

### Password Input

By default, passwords are prompted interactively without echo. Use `--password` to read from stdin instead:

```bash
echo "secret" | htauth add .htpasswd alice --password
```

### Hash Algorithms

| Algorithm | Identifier | Description |
|-----------|------------|-------------|
| bcrypt | `bcrypt` | Default; secure and widely supported |
| SHA-256 | `sha256` | `$5$` format |
| SHA-512 | `sha512` | `$6$` format |
| APR1-MD5 | `apr1` | `$apr1$` format; Apache legacy |

The library can read and verify all formats. New passwords default to `bcrypt` unless `--algorithm` is specified.

### Compatibility

Files generated by `htauth` are fully compatible with Apache's `htpasswd` tool and vice versa. The CLI interface uses subcommands instead of flags, so it is not a drop-in replacement for scripts that expect `htpasswd`'s flag-based syntax.

---

## For Developers

### Usage as a Library

```toml
[dependencies]
htauth = "0.1"
```

```rust
use htauth::{Htpasswd, HashAlgorithm};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Open or create an htpasswd file
    let mut htpasswd = Htpasswd::open(".htpasswd")?;

    // Add a new user with a specific hash algorithm
    htpasswd.add_user("alice", "password123", HashAlgorithm::Bcrypt)?;

    // Verify credentials
    if htpasswd.verify_user("alice", "password123")? {
        println!("Authentication successful");
    }

    // List all usernames
    for username in htpasswd.list_users() {
        println!("{}", username);
    }

    // Remove a user
    htpasswd.delete_user("alice")?;

    // Persist changes to disk
    htpasswd.save()?;

    Ok(())
}
```

### API Overview

- **`Htpasswd`**: Main type for loading, modifying, and saving password files
- **`HashAlgorithm`**: Enum representing supported hash algorithms
- **`hash_password` / `verify_password`**: Standalone functions for password hashing
- **`detect_algorithm`**: Detect algorithm from an existing hash string

### Error Handling

The library uses [`snafu`](https://docs.rs/snafu) for structured error handling. Each module defines its own `Error` enum, re-exported at the crate level:
- `HashError` — password hashing errors
- `HtpasswdError` — file parsing and I/O errors
- `Apr1Md5Error` — APR1-MD5 specific errors

### Minimum Supported Rust Version

**Rust 1.85** or later. The project uses Rust 2024 edition.

### Development

```bash
# Check the workspace
cargo check

# Run all tests
cargo test

# Lint
cargo clippy --all-targets

# Format
cargo fmt
```

### Testing Compatibility

The `tests/compatibility.sh` script verifies bidirectional compatibility with Apache `htpasswd`. Requires `/usr/bin/htpasswd` to be installed.

```bash
sudo apt install apache2-utils  # or equivalent
bash tests/compatibility.sh
```
